ebd6e7785ffa7b521df01c3af76cf1c4
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var infoLog = require("../Utilities/infoLog");

var invariant = require('invariant');

var DEBUG = false;

var TaskQueue = function () {
  function TaskQueue(_ref) {
    var onMoreTasks = _ref.onMoreTasks;
    (0, _classCallCheck2.default)(this, TaskQueue);
    this._onMoreTasks = onMoreTasks;
    this._queueStack = [{
      tasks: [],
      popable: false
    }];
  }

  (0, _createClass2.default)(TaskQueue, [{
    key: "enqueue",
    value: function enqueue(task) {
      this._getCurrentQueue().push(task);
    }
  }, {
    key: "enqueueTasks",
    value: function enqueueTasks(tasks) {
      var _this = this;

      tasks.forEach(function (task) {
        return _this.enqueue(task);
      });
    }
  }, {
    key: "cancelTasks",
    value: function cancelTasks(tasksToCancel) {
      this._queueStack = this._queueStack.map(function (queue) {
        return _objectSpread(_objectSpread({}, queue), {}, {
          tasks: queue.tasks.filter(function (task) {
            return tasksToCancel.indexOf(task) === -1;
          })
        });
      }).filter(function (queue, idx) {
        return queue.tasks.length > 0 || idx === 0;
      });
    }
  }, {
    key: "hasTasksToProcess",
    value: function hasTasksToProcess() {
      return this._getCurrentQueue().length > 0;
    }
  }, {
    key: "processNext",
    value: function processNext() {
      var queue = this._getCurrentQueue();

      if (queue.length) {
        var task = queue.shift();

        try {
          if (task.gen) {
            DEBUG && infoLog('TaskQueue: genPromise for task ' + task.name);

            this._genPromise(task);
          } else if (task.run) {
            DEBUG && infoLog('TaskQueue: run task ' + task.name);
            task.run();
          } else {
            invariant(typeof task === 'function', 'Expected Function, SimpleTask, or PromiseTask, but got:\n' + JSON.stringify(task, null, 2));
            DEBUG && infoLog('TaskQueue: run anonymous task');
            task();
          }
        } catch (e) {
          e.message = 'TaskQueue: Error with task ' + (task.name || '') + ': ' + e.message;
          throw e;
        }
      }
    }
  }, {
    key: "_getCurrentQueue",
    value: function _getCurrentQueue() {
      var stackIdx = this._queueStack.length - 1;
      var queue = this._queueStack[stackIdx];

      if (queue.popable && queue.tasks.length === 0 && this._queueStack.length > 1) {
        this._queueStack.pop();

        DEBUG && infoLog('TaskQueue: popped queue: ', {
          stackIdx: stackIdx,
          queueStackSize: this._queueStack.length
        });
        return this._getCurrentQueue();
      } else {
        return queue.tasks;
      }
    }
  }, {
    key: "_genPromise",
    value: function _genPromise(task) {
      var _this2 = this;

      this._queueStack.push({
        tasks: [],
        popable: false
      });

      var stackIdx = this._queueStack.length - 1;
      DEBUG && infoLog('TaskQueue: push new queue: ', {
        stackIdx: stackIdx
      });
      DEBUG && infoLog('TaskQueue: exec gen task ' + task.name);
      task.gen().then(function () {
        DEBUG && infoLog('TaskQueue: onThen for gen task ' + task.name, {
          stackIdx: stackIdx,
          queueStackSize: _this2._queueStack.length
        });
        _this2._queueStack[stackIdx].popable = true;
        _this2.hasTasksToProcess() && _this2._onMoreTasks();
      }).catch(function (ex) {
        ex.message = "TaskQueue: Error resolving Promise in task " + task.name + ": " + ex.message;
        throw ex;
      }).done();
    }
  }]);
  return TaskQueue;
}();

module.exports = TaskQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRhc2tRdWV1ZS5qcyJdLCJuYW1lcyI6WyJpbmZvTG9nIiwicmVxdWlyZSIsImludmFyaWFudCIsIkRFQlVHIiwiVGFza1F1ZXVlIiwib25Nb3JlVGFza3MiLCJfb25Nb3JlVGFza3MiLCJfcXVldWVTdGFjayIsInRhc2tzIiwicG9wYWJsZSIsInRhc2siLCJfZ2V0Q3VycmVudFF1ZXVlIiwicHVzaCIsImZvckVhY2giLCJlbnF1ZXVlIiwidGFza3NUb0NhbmNlbCIsIm1hcCIsInF1ZXVlIiwiZmlsdGVyIiwiaW5kZXhPZiIsImlkeCIsImxlbmd0aCIsInNoaWZ0IiwiZ2VuIiwibmFtZSIsIl9nZW5Qcm9taXNlIiwicnVuIiwiSlNPTiIsInN0cmluZ2lmeSIsImUiLCJtZXNzYWdlIiwic3RhY2tJZHgiLCJwb3AiLCJxdWV1ZVN0YWNrU2l6ZSIsInRoZW4iLCJoYXNUYXNrc1RvUHJvY2VzcyIsImNhdGNoIiwiZXgiLCJkb25lIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsT0FBTyxHQUFHQyxPQUFPLHdCQUF2Qjs7QUFDQSxJQUFNQyxTQUFTLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQVlBLElBQU1FLEtBQVksR0FBRyxLQUFyQjs7SUFrQk1DLFM7QUFRSiwyQkFBc0Q7QUFBQSxRQUF6Q0MsV0FBeUMsUUFBekNBLFdBQXlDO0FBQUE7QUFDcEQsU0FBS0MsWUFBTCxHQUFvQkQsV0FBcEI7QUFDQSxTQUFLRSxXQUFMLEdBQW1CLENBQUM7QUFBQ0MsTUFBQUEsS0FBSyxFQUFFLEVBQVI7QUFBWUMsTUFBQUEsT0FBTyxFQUFFO0FBQXJCLEtBQUQsQ0FBbkI7QUFDRDs7Ozs0QkFPT0MsSSxFQUFrQjtBQUN4QixXQUFLQyxnQkFBTCxHQUF3QkMsSUFBeEIsQ0FBNkJGLElBQTdCO0FBQ0Q7OztpQ0FFWUYsSyxFQUEwQjtBQUFBOztBQUNyQ0EsTUFBQUEsS0FBSyxDQUFDSyxPQUFOLENBQWMs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aXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZvcm1hdFxuICogQGZsb3dcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IGluZm9Mb2cgPSByZXF1aXJlKCcuLi9VdGlsaXRpZXMvaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbnR5cGUgU2ltcGxlVGFzayA9IHtcbiAgbmFtZTogc3RyaW5nLFxuICBydW46ICgpID0+IHZvaWQsXG59O1xudHlwZSBQcm9taXNlVGFzayA9IHtcbiAgbmFtZTogc3RyaW5nLFxuICBnZW46ICgpID0+IFByb21pc2U8YW55Pixcbn07XG5leHBvcnQgdHlwZSBUYXNrID0gRnVuY3Rpb24gfCBTaW1wbGVUYXNrIHwgUHJvbWlzZVRhc2s7XG5cbmNvbnN0IERFQlVHOiBmYWxzZSA9IGZhbHNlO1xuXG4vKipcbiAqIFRhc2tRdWV1ZSAtIEEgc3lzdGVtIGZvciBxdWV1ZWluZyBhbmQgZXhlY3V0aW5nIGEgbWl4IG9mIHNpbXBsZSBjYWxsYmFja3MgYW5kXG4gKiB0cmVlcyBvZiBkZXBlbmRlbnQgdGFza3MgYmFzZWQgb24gUHJvbWlzZXMuIE5vIHRhc2tzIGFyZSBleGVjdXRlZCB1bmxlc3NcbiAqIGBwcm9jZXNzTmV4dGAgaXMgY2FsbGVkLlxuICpcbiAqIGBlbnF1ZXVlYCB0YWtlcyBhIFRhc2sgb2JqZWN0IHdpdGggZWl0aGVyIGEgc2ltcGxlIGBydW5gIGNhbGxiYWNrLCBvciBhXG4gKiBgZ2VuYCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBgUHJvbWlzZWAgYW5kIHB1dHMgaXQgaW4gdGhlIHF1ZXVlLiAgSWYgYSBnZW5cbiAqIGZ1bmN0aW9uIGlzIHN1cHBsaWVkLCB0aGVuIHRoZSBwcm9taXNlIGl0IHJldHVybnMgd2lsbCBibG9jayBleGVjdXRpb24gb2ZcbiAqIHRhc2tzIGFscmVhZHkgaW4gdGhlIHF1ZXVlIHVudGlsIGl0IHJlc29sdmVzLiBUaGlzIGNhbiBiZSB1c2VkIHRvIG1ha2Ugc3VyZVxuICogdGhlIGZpcnN0IHRhc2sgaXMgZnVsbHkgcmVzb2x2ZWQgKGluY2x1ZGluZyBhc3luY2hyb25vdXMgZGVwZW5kZW5jaWVzIHRoYXRcbiAqIGFsc28gc2NoZWR1bGUgbW9yZSB0YXNrcyB2aWEgYGVucXVldWVgKSBiZWZvcmUgc3RhcnRpbmcgb24gdGhlIG5leHQgdGFzay5cbiAqIFRoZSBgb25Nb3JlVGFza3NgIGNvbnN0cnVjdG9yIGFyZ3VtZW50IGlzIHVzZWQgdG8gaW5mb3JtIHRoZSBvd25lciB0aGF0IGFuXG4gKiBhc3luYyB0YXNrIGhhcyByZXNvbHZlZCBhbmQgdGhhdCB0aGUgcXVldWUgc2hvdWxkIGJlIHByb2Nlc3NlZCBhZ2Fpbi5cbiAqXG4gKiBOb3RlOiBUYXNrcyBhcmUgb25seSBhY3R1YWxseSBleGVjdXRlZCB3aXRoIGV4cGxpY2l0IGNhbGxzIHRvIGBwcm9jZXNzTmV4dGAuXG4gKi9cbmNsYXNzIFRhc2tRdWV1ZSB7XG4gIC8qKlxuICAgKiBUYXNrUXVldWUgaW5zdGFuY2VzIGFyZSBzZWxmIGNvbnRhaW5lZCBhbmQgaW5kZXBlbmRlbnQsIHNvIG11bHRpcGxlIHRhc2tzXG4gICAqIG9mIHZhcnlpbmcgc2VtYW50aWNzIGFuZCBwcmlvcml0eSBjYW4gb3BlcmF0ZSB0b2dldGhlci5cbiAgICpcbiAgICogYG9uTW9yZVRhc2tzYCBpcyBpbnZva2VkIHdoZW4gYFByb21pc2VUYXNrYHMgcmVzb2x2ZSBpZiB0aGVyZSBhcmUgbW9yZVxuICAgKiB0YXNrcyB0byBwcm9jZXNzLlxuICAgKi9cbiAgY29uc3RydWN0b3Ioe29uTW9yZVRhc2tzfToge29uTW9yZVRhc2tzOiAoKSA9PiB2b2lkfSkge1xuICAgIHRoaXMuX29uTW9yZVRhc2tzID0gb25Nb3JlVGFza3M7XG4gICAgdGhpcy5fcXVldWVTdGFjayA9IFt7dGFza3M6IFtdLCBwb3BhYmxlOiBmYWxzZX1dO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIHRhc2sgdG8gdGhlIHF1ZXVlLiAgSXQgaXMgcmVjb21tZW5kZWQgdG8gbmFtZSB5b3VyIHRhc2tzIGZvciBlYXNpZXJcbiAgICogYXN5bmMgZGVidWdnaW5nLiBUYXNrcyB3aWxsIG5vdCBiZSBleGVjdXRlZCB1bnRpbCBgcHJvY2Vzc05leHRgIGlzIGNhbGxlZFxuICAgKiBleHBsaWNpdGx5LlxuICAgKi9cbiAgZW5xdWV1ZSh0YXNrOiBUYXNrKTogdm9pZCB7XG4gICAgdGhpcy5fZ2V0Q3VycmVudFF1ZXVlKCkucHVzaCh0YXNrKTtcbiAgfVxuXG4gIGVucXVldWVUYXNrcyh0YXNrczogQXJyYXk8VGFzaz4pOiB2b2lkIHtcbiAgICB0YXNrcy5mb3JFYWNoKHRhc2sgPT4gdGhpcy5lbnF1ZXVlKHRhc2spKTtcbiAgfVxuXG4gIGNhbmNlbFRhc2tzKHRhc2tzVG9DYW5jZWw6IEFycmF5PFRhc2s+KTogdm9pZCB7XG4gICAgLy8gc2VhcmNoIHRocm91Z2ggYWxsIHRhc2tzIGFuZCByZW1vdmUgdGhlbS5cbiAgICB0aGlzLl9xdWV1ZVN0YWNrID0gdGhpcy5fcXVldWVTdGFja1xuICAgICAgLm1hcChxdWV1ZSA9PiAoe1xuICAgICAgICAuLi5xdWV1ZSxcbiAgICAgICAgdGFza3M6IHF1ZXVlLnRhc2tzLmZpbHRlcih0YXNrID0+IHRhc2tzVG9DYW5jZWwuaW5kZXhPZih0YXNrKSA9PT0gLTEpLFxuICAgICAgfSkpXG4gICAgICAuZmlsdGVyKChxdWV1ZSwgaWR4KSA9PiBxdWV1ZS50YXNrcy5sZW5ndGggPiAwIHx8IGlkeCA9PT0gMCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgdG8gc2VlIGlmIGBwcm9jZXNzTmV4dGAgc2hvdWxkIGJlIGNhbGxlZC5cbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGVyZSBhcmUgdGFza3MgdGhhdCBhcmUgcmVhZHkgdG8gYmVcbiAgICogcHJvY2Vzc2VkIHdpdGggYHByb2Nlc3NOZXh0YCwgb3IgcmV0dXJucyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gbW9yZSB0YXNrc1xuICAgKiB0byBiZSBwcm9jZXNzZWQgcmlnaHQgbm93LCBhbHRob3VnaCB0aGVyZSBtYXkgYmUgdGFza3MgaW4gdGhlIHF1ZXVlIHRoYXRcbiAgICogYXJlIGJsb2NrZWQgYnkgZWFybGllciBgUHJvbWlzZVRhc2tgcyB0aGF0IGhhdmVuJ3QgcmVzb2x2ZWQgeWV0LlxuICAgKiBgb25Nb3JlVGFza3NgIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGVhY2ggYFByb21pc2VUYXNrYCByZXNvbHZlcyBpZiB0aGVyZSBhcmVcbiAgICogdGFza3MgcmVhZHkgdG8gcnVuIGF0IHRoYXQgcG9pbnQuXG4gICAqL1xuICBoYXNUYXNrc1RvUHJvY2VzcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudFF1ZXVlKCkubGVuZ3RoID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlcyB0aGUgbmV4dCB0YXNrIGluIHRoZSBxdWV1ZS5cbiAgICovXG4gIHByb2Nlc3NOZXh0KCk6IHZvaWQge1xuICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5fZ2V0Q3VycmVudFF1ZXVlKCk7XG4gICAgaWYgKHF1ZXVlLmxlbmd0aCkge1xuICAgICAgY29uc3QgdGFzayA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAodGFzay5nZW4pIHtcbiAgICAgICAgICBERUJVRyAmJiBpbmZvTG9nKCdUYXNrUXVldWU6IGdlblByb21pc2UgZm9yIHRhc2sgJyArIHRhc2submFtZSk7XG4gICAgICAgICAgdGhpcy5fZ2VuUHJvbWlzZSgodGFzazogYW55KSk7IC8vIFJhdGhlciB0aGFuIGFubm95aW5nIHRhZ2dlZCB1bmlvblxuICAgICAgICB9IGVsc2UgaWYgKHRhc2sucnVuKSB7XG4gICAgICAgICAgREVCVUcgJiYgaW5mb0xvZygnVGFza1F1ZXVlOiBydW4gdGFzayAnICsgdGFzay5uYW1lKTtcbiAgICAgICAgICB0YXNrLnJ1bigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGludmFyaWFudChcbiAgICAgICAgICAgIHR5cGVvZiB0YXNrID09PSAnZnVuY3Rpb24nLFxuICAgICAgICAgICAgJ0V4cGVjdGVkIEZ1bmN0aW9uLCBTaW1wbGVUYXNrLCBvciBQcm9taXNlVGFzaywgYnV0IGdvdDpcXG4nICtcbiAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGFzaywgbnVsbCwgMiksXG4gICAgICAgICAgKTtcbiAgICAgICAgICBERUJVRyAmJiBpbmZvTG9nKCdUYXNrUXVldWU6IHJ1biBhbm9ueW1vdXMgdGFzaycpO1xuICAgICAgICAgIHRhc2soKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBlLm1lc3NhZ2UgPVxuICAgICAgICAgICdUYXNrUXVldWU6IEVycm9yIHdpdGggdGFzayAnICsgKHRhc2submFtZSB8fCAnJykgKyAnOiAnICsgZS5tZXNzYWdlO1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIF9xdWV1ZVN0YWNrOiBBcnJheTx7dGFza3M6IEFycmF5PFRhc2s+LCBwb3BhYmxlOiBib29sZWFufT47XG4gIF9vbk1vcmVUYXNrczogKCkgPT4gdm9pZDtcblxuICBfZ2V0Q3VycmVudFF1ZXVlKCk6IEFycmF5PFRhc2s+IHtcbiAgICBjb25zdCBzdGFja0lkeCA9IHRoaXMuX3F1ZXVlU3RhY2subGVuZ3RoIC0gMTtcbiAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3F1ZXVlU3RhY2tbc3RhY2tJZHhdO1xuICAgIGlmIChcbiAgICAgIHF1ZXVlLnBvcGFibGUgJiZcbiAgICAgIHF1ZXVlLnRhc2tzLmxlbmd0aCA9PT0gMCAmJlxuICAgICAgdGhpcy5fcXVldWVTdGFjay5sZW5ndGggPiAxXG4gICAgKSB7XG4gICAgICB0aGlzLl9xdWV1ZVN0YWNrLnBvcCgpO1xuICAgICAgREVCVUcgJiZcbiAgICAgICAgaW5mb0xvZygnVGFza1F1ZXVlOiBwb3BwZWQgcXVldWU6ICcsIHtcbiAgICAgICAgICBzdGFja0lkeCxcbiAgICAgICAgICBxdWV1ZVN0YWNrU2l6ZTogdGhpcy5fcXVldWVTdGFjay5sZW5ndGgsXG4gICAgICAgIH0pO1xuICAgICAgcmV0dXJuIHRoaXMuX2dldEN1cnJlbnRRdWV1ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcXVldWUudGFza3M7XG4gICAgfVxuICB9XG5cbiAgX2dlblByb21pc2UodGFzazogUHJvbWlzZVRhc2spIHtcbiAgICAvLyBFYWNoIGFzeW5jIHRhc2sgcHVzaGVzIGl0J3Mgb3duIHF1ZXVlIG9udG8gdGhlIHF1ZXVlIHN0YWNrLiBUaGlzXG4gICAgLy8gZWZmZWN0aXZlbHkgZGVmZXJzIGV4ZWN1dGlvbiBvZiBwcmV2aW91c2x5IHF1ZXVlZCB0YXNrcyB1bnRpbCB0aGUgcHJvbWlzZVxuICAgIC8vIHJlc29sdmVzLCBhdCB3aGljaCBwb2ludCB3ZSBhbGxvdyB0aGUgbmV3IHF1ZXVlIHRvIGJlIHBvcHBlZCwgd2hpY2hcbiAgICAvLyBoYXBwZW5zIG9uY2UgaXQgaXMgZnVsbHkgcHJvY2Vzc2VkLlxuICAgIHRoaXMuX3F1ZXVlU3RhY2sucHVzaCh7dGFza3M6IFtdLCBwb3BhYmxlOiBmYWxzZX0pO1xuICAgIGNvbnN0IHN0YWNrSWR4ID0gdGhpcy5fcXVldWVTdGFjay5sZW5ndGggLSAxO1xuICAgIERFQlVHICYmIGluZm9Mb2coJ1Rhc2tRdWV1ZTogcHVzaCBuZXcgcXVldWU6ICcsIHtzdGFja0lkeH0pO1xuICAgIERFQlVHICYmIGluZm9Mb2coJ1Rhc2tRdWV1ZTogZXhlYyBnZW4gdGFzayAnICsgdGFzay5uYW1lKTtcbiAgICB0YXNrXG4gICAgICAuZ2VuKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgREVCVUcgJiZcbiAgICAgICAgICBpbmZvTG9nKCdUYXNrUXVldWU6IG9uVGhlbiBmb3IgZ2VuIHRhc2sgJyArIHRhc2submFtZSwge1xuICAgICAgICAgICAgc3RhY2tJZHgsXG4gICAgICAgICAgICBxdWV1ZVN0YWNrU2l6ZTogdGhpcy5fcXVldWVTdGFjay5sZW5ndGgsXG4gICAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuX3F1ZXVlU3RhY2tbc3RhY2tJZHhdLnBvcGFibGUgPSB0cnVlO1xuICAgICAgICB0aGlzLmhhc1Rhc2tzVG9Qcm9jZXNzKCkgJiYgdGhpcy5fb25Nb3JlVGFza3MoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXggPT4ge1xuICAgICAgICBleC5tZXNzYWdlID0gYFRhc2tRdWV1ZTogRXJyb3IgcmVzb2x2aW5nIFByb21pc2UgaW4gdGFzayAke1xuICAgICAgICAgIHRhc2submFtZVxuICAgICAgICB9OiAke2V4Lm1lc3NhZ2V9YDtcbiAgICAgICAgdGhyb3cgZXg7XG4gICAgICB9KVxuICAgICAgLmRvbmUoKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRhc2tRdWV1ZTtcbiJdfQ==